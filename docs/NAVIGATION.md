
# üß≠ Gu√≠a de Navegaci√≥n EscalaFin

## üìã Resumen

EscalaFin implementa un sistema de navegaci√≥n dual optimizado para diferentes tipos de dispositivos y experiencias de usuario:

- **üñ•Ô∏è Desktop**: Sidebar navegacional sticky persistente
- **üì± Mobile**: Header con men√∫ hamburguesa + Sheet drawer deslizante
- **üéØ PWA**: M√≥dulos din√°micos basados en permisos de usuario

---

## üèóÔ∏è Arquitectura de Navegaci√≥n

### Componentes Principales

```tsx
// Estructura general del sistema
<LayoutProvider>
  {/* Visible solo en desktop (‚â•768px) */}
  <Sidebar />
  <Header />
  
  {/* Visible solo en mobile (<768px) */}
  <HeaderMobile />
  
  <MainContent>
    {children}
  </MainContent>
</LayoutProvider>
```

### üìÇ Archivos Clave

| **Componente** | **Archivo** | **Responsabilidad** |
|----------------|-------------|-------------------|
| **LayoutProvider** | `/components/layout/layout-provider.tsx` | Orchestrador principal de navegaci√≥n |
| **Sidebar** | `/components/layout/sidebar.tsx` | Navegaci√≥n desktop sticky |
| **HeaderMobile** | `/components/layout/header-mobile.tsx` | Navegaci√≥n m√≥vil optimizada |
| **Header** | `/components/layout/header.tsx` | Header desktop minimalista |
| **Sheet** | `/components/ui/sheet.tsx` | Component drawer para mobile |

---

## üñ•Ô∏è Navegaci√≥n Desktop (Sidebar)

### Caracter√≠sticas

- **üìå Sticky positioning** - Siempre visible durante scroll
- **üîÑ Colapsible/expandible** - Usuario puede alternar tama√±o
- **üìÇ Categorizaci√≥n** - M√≥dulos organizados por funci√≥n
- **üéØ Active state** - Indicador visual de p√°gina actual
- **üë§ User info** - Avatar y datos del usuario en footer
- **‚ö° Transitions** - Animaciones suaves entre estados

### Estados del Sidebar

#### 1. Expandido (Default - w-64)
```tsx
// Ancho completo con iconos + etiquetas
<div className="w-64">
  <Icon />
  <span>Nombre del M√≥dulo</span>
</div>
```

#### 2. Colapsado (w-16) 
```tsx  
// Solo iconos visibles
<div className="w-16">
  <Icon />
  {/* span oculto */}
</div>
```

#### 3. Oculto (< 768px)
```tsx
// Completamente oculto en mobile
<div className="hidden md:flex">
  {/* Sidebar content */}
</div>
```

### Estructura de M√≥dulos

```tsx
const navigationItems = [
  {
    category: 'Principal',
    items: [
      {
        title: 'Dashboard',
        icon: LayoutDashboard,
        href: '/admin/dashboard', // Dynamic basado en rol
      }
    ]
  },
  {
    category: 'Gesti√≥n', 
    items: [
      {
        title: 'Clientes',
        icon: Users,
        href: '/clients',
        moduleKey: 'client_list',
        roles: ['ADMIN', 'ASESOR']
      },
      // ... m√°s m√≥dulos
    ]
  }
  // ... m√°s categor√≠as
];
```

---

## üì± Navegaci√≥n M√≥vil

### Caracter√≠sticas

- **üçî Hamburger menu** - Icono universal de men√∫
- **üì± Sheet/Drawer** - Panel deslizante desde la derecha
- **üëÜ Touch-optimized** - Botones y √°reas de toque ampliadas
- **üìã Complete navigation** - Acceso a todos los m√≥dulos
- **üë§ User profile** - Info del usuario prominente
- **‚ö° Smooth animations** - Transiciones fluidas

### Componentes

#### HeaderMobile
```tsx
<header className="md:hidden sticky top-0 z-50">
  <div className="flex items-center justify-between">
    <Logo />
    <Sheet>
      <SheetTrigger>
        <Menu />
      </SheetTrigger>
      <SheetContent>
        <Navigation />
      </SheetContent>
    </Sheet>
  </div>
</header>
```

#### Navigation Drawer
```tsx
<SheetContent side="right" className="w-80">
  <UserInfo />
  <NavigationList />
  <ActionButtons />
</SheetContent>
```

---

## üîê Sistema de Permisos y Filtrado

### L√≥gica de Filtrado

```typescript
const getFilteredItems = (items: NavigationItem[]) => {
  return items.filter(item => {
    // 1. Verificar rol del usuario
    if (item.roles && !item.roles.includes(userRole)) {
      return false;
    }
    
    // 2. Verificar m√≥dulo habilitado en PWA
    if (item.moduleKey) {
      return modules.some(module => module.moduleKey === item.moduleKey);
    }
    
    return true;
  });
};
```

### Roles y Permisos

| **Rol** | **Acceso** | **M√≥dulos** |
|---------|------------|------------|
| **ADMIN** | üî¥ Completo | Todos los m√≥dulos + configuraci√≥n |
| **ASESOR** | üîµ Operativo | Gesti√≥n, reportes, comunicaci√≥n |
| **CLIENTE** | üü¢ Limitado | Dashboard personal, pr√©stamos propios |

### Verificaci√≥n PWA

```sql
-- Verificar m√≥dulos habilitados para usuario
SELECT m.*, rp.*
FROM "PWAModule" m
JOIN "ModuleRolePermission" rp ON m.id = rp."moduleId"  
WHERE m.status = 'ENABLED' 
AND rp.role = 'ADMIN'
AND rp.enabled = true;
```

---

## üìê Responsive Design

### Breakpoints Tailwind

```css
/* Mobile first approach */
sm: 640px   /* Small devices */
md: 768px   /* Tablets - PUNTO DE CAMBIO PRINCIPAL */
lg: 1024px  /* Laptops */
xl: 1280px  /* Desktops */
2xl: 1536px /* Large screens */
```

### Estrategia Responsive

```tsx
// Componente que muestra diferente UI seg√∫n breakpoint
<div className="navigation">
  {/* Desktop: Sidebar siempre visible */}
  <div className="hidden md:block">
    <Sidebar />
  </div>
  
  {/* Mobile: Header con men√∫ hamburguesa */}
  <div className="md:hidden">
    <HeaderMobile />
  </div>
</div>
```

---

## üé® Estilos y Animaciones

### Transiciones CSS

```css
/* Sidebar collapse/expand animation */
.sidebar {
  transition: width 300ms cubic-bezier(0.4, 0, 0.2, 1);
}

/* Navigation item hover effects */
.nav-item {
  transition: all 200ms ease-in-out;
}

.nav-item:hover {
  background-color: theme('colors.primary.50');
  transform: translateX(4px);
}

/* Sheet slide animation */
.sheet-content {
  animation: slideIn 250ms ease-out;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}
```

### Estados Visuales

```tsx
// Active page indicator
<Button 
  className={cn(
    'navigation-item',
    isActive && 'bg-primary/10 text-primary border-primary/20'
  )}
>
  <Icon />
  <span>{title}</span>
</Button>
```

---

## ‚ö° Performance Optimizations

### Lazy Loading

```tsx
// Cargar m√≥dulos de navegaci√≥n din√°micamente
const NavigationItem = lazy(() => import('./NavigationItem'));

// Suspense boundary
<Suspense fallback={<NavigationSkeleton />}>
  <NavigationItem {...props} />
</Suspense>
```

### Memoizaci√≥n

```tsx
// Memorizar items filtrados para evitar re-renders
const filteredItems = useMemo(() => {
  return getFilteredItems(navigationItems);
}, [navigationItems, userRole, modules]);

// Memorizar estado activo
const isActive = useCallback((href: string) => {
  return pathname.startsWith(href);
}, [pathname]);
```

### Virtual Scrolling

```tsx
// Para listas muy largas de m√≥dulos (futuro)
import { FixedSizeList as List } from 'react-window';

<List
  height={400}
  itemCount={filteredItems.length}
  itemSize={48}
  itemData={filteredItems}
>
  {NavigationItem}
</List>
```

---

## üß™ Testing de Navegaci√≥n

### Tests Unitarios

```typescript
// sidebar.test.tsx
describe('Sidebar Navigation', () => {
  test('shows correct modules for ADMIN role', () => {
    render(<Sidebar />, { 
      wrapper: createAuthWrapper({ role: 'ADMIN' })
    });
    
    expect(screen.getByText('Gestionar Usuarios')).toBeInTheDocument();
  });
  
  test('collapses when toggle button clicked', () => {
    render(<Sidebar />);
    
    fireEvent.click(screen.getByRole('button', { name: /collapse/i }));
    expect(screen.getByTestId('sidebar')).toHaveClass('w-16');
  });
});
```

### Tests de Integraci√≥n

```typescript
// navigation-flow.test.tsx
describe('Navigation Flow', () => {
  test('desktop to mobile navigation consistency', () => {
    const { rerender } = render(<App />);
    
    // Desktop navigation
    expect(screen.getByTestId('sidebar')).toBeVisible();
    expect(screen.queryByTestId('mobile-header')).not.toBeVisible();
    
    // Switch to mobile viewport
    Object.defineProperty(window, 'innerWidth', { value: 600 });
    rerender(<App />);
    
    expect(screen.queryByTestId('sidebar')).not.toBeVisible();
    expect(screen.getByTestId('mobile-header')).toBeVisible();
  });
});
```

### Tests Visuales

```typescript
// visual-regression.test.tsx
describe('Navigation Visual Tests', () => {
  test('sidebar renders correctly', async () => {
    const component = render(<Sidebar />);
    const image = await percySnapshot('Sidebar - Expanded');
    expect(image).toMatchSnapshot();
  });
  
  test('mobile navigation renders correctly', async () => {
    const component = render(<HeaderMobile />);
    const image = await percySnapshot('Mobile Navigation - Sheet Open');
    expect(image).toMatchSnapshot();
  });
});
```

---

## üêõ Troubleshooting Common Issues

### Sidebar no aparece

```typescript
// Debug checklist
const debugSidebar = () => {
  // 1. Verificar breakpoint
  console.log('Window width:', window.innerWidth); // Should be ‚â• 768px
  
  // 2. Verificar sesi√≥n
  console.log('User session:', session); // Should exist
  
  // 3. Verificar m√≥dulos
  console.log('Available modules:', modules); // Should not be empty
  
  // 4. Verificar CSS
  const sidebar = document.querySelector('[data-testid="sidebar"]');
  console.log('Sidebar styles:', window.getComputedStyle(sidebar));
};
```

### M√≥dulos no se filtran correctamente

```sql
-- Verificar en base de datos
-- 1. M√≥dulo existe y est√° habilitado
SELECT * FROM "PWAModule" WHERE "moduleKey" = 'client_list';

-- 2. Permisos por rol configurados
SELECT * FROM "ModuleRolePermission" 
WHERE "moduleId" IN (
  SELECT id FROM "PWAModule" WHERE "moduleKey" = 'client_list'
) AND role = 'ADMIN';

-- 3. Usuario tiene el rol correcto
SELECT role FROM "User" WHERE email = 'admin@escalafin.com';
```

### Performance lenta en navegaci√≥n

```typescript
// Profiling de performance
import { Profiler } from 'react';

<Profiler id="Navigation" onRender={(id, phase, actualDuration) => {
  console.log('Navigation render:', { id, phase, actualDuration });
}}>
  <NavigationComponent />
</Profiler>
```

---

## üîÑ Migraci√≥n de Navegaci√≥n Legacy

### Pasos para migrar navegaci√≥n existente

1. **Backup** de componentes actuales
2. **Instalar** nuevos componentes de layout
3. **Configurar** LayoutProvider en layout ra√≠z
4. **Migrar** rutas y enlaces existentes
5. **Testing** completo en todos los breakpoints
6. **Deploy** gradual con feature flags

### Script de migraci√≥n

```bash
#!/bin/bash
# migrate-navigation.sh

echo "üîÑ Iniciando migraci√≥n de navegaci√≥n..."

# Backup de componentes existentes
mkdir -p backup/components/navigation
cp -r components/navigation/* backup/components/navigation/

# Instalar nuevos componentes
echo "üì¶ Instalando nuevos componentes..."
# (Los nuevos componentes ya est√°n instalados)

# Actualizar layout ra√≠z
echo "üèóÔ∏è Actualizando layout..."
# (Ya actualizado en app/layout.tsx)

# Ejecutar tests
echo "üß™ Ejecutando tests de navegaci√≥n..."
yarn test --testPathPattern=navigation

echo "‚úÖ Migraci√≥n completada!"
```

---

## üìà M√©tricas y Analytics

### KPIs de Navegaci√≥n

```typescript
// M√©tricas a monitorear
const navigationMetrics = {
  // Performance
  sidebarRenderTime: '< 100ms',
  mobileMenuOpenTime: '< 50ms',
  moduleFilterTime: '< 200ms',
  
  // Usage
  sidebarCollapseRate: '15%', // Usuarios que colapsan sidebar
  mobileMenuUsage: '85%',     // Usuarios que usan men√∫ m√≥vil
  moduleClickthrough: '92%',  // Navegaci√≥n exitosa a m√≥dulos
  
  // Errors
  navigationErrors: '< 0.1%', // Errores de navegaci√≥n
  moduleLoadErrors: '< 0.5%', // Errores de carga de m√≥dulos
};
```

### Tracking de Eventos

```typescript
// analytics.ts
export const trackNavigation = (event: string, properties: object) => {
  // Google Analytics 4
  gtag('event', event, {
    event_category: 'navigation',
    ...properties
  });
  
  // Custom analytics
  analytics.track(event, {
    category: 'navigation',
    timestamp: new Date().toISOString(),
    ...properties
  });
};

// Uso en componentes
const handleSidebarToggle = () => {
  setCollapsed(!collapsed);
  trackNavigation('sidebar_toggle', {
    action: collapsed ? 'expand' : 'collapse',
    userRole: session?.user?.role
  });
};
```

---

## üöÄ Futuras Mejoras

### Roadmap de Navegaci√≥n

#### v2.2.0
- **üîç B√∫squeda** en sidebar con filtrado inteligente
- **üìå Bookmarks** m√≥dulos favoritos del usuario  
- **üé® Temas personalizables** colores de navegaci√≥n
- **‚å®Ô∏è Keyboard shortcuts** navegaci√≥n por teclado

#### v2.3.0  
- **ü§ñ AI-powered** sugerencias de navegaci√≥n
- **üìä Usage analytics** dashboard interno
- **üéØ Context-aware** navigation basada en flujo de trabajo
- **üì± Gestures support** swipe navigation en mobile

#### v3.0.0
- **üåç Multi-tenant** navegaci√≥n personalizada por organizaci√≥n
- **üîß Custom modules** capacidad de agregar m√≥dulos externos
- **üé® Visual builder** editor drag-and-drop para navegaci√≥n
- **üìà A/B testing** framework para optimizar UX

---

*Documentaci√≥n actualizada: Septiembre 2025*  
*EscalaFin v2.1.0 - Navigation System*
