generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
  output        = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  domain      String?  @unique
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  clients     Client[]
  config      SystemConfig[]
  wahaConfig  WahaConfig[]
  messageTemplates MessageTemplate[]
  reportTemplates  ReportTemplate[]

  @@map("tenants")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id                         String                   @id @default(cuid())
  email                      String                   @unique
  password                   String?
  firstName                  String
  lastName                   String
  phone                      String?
  role                       UserRole                 @default(CLIENTE)
  status                     UserStatus               @default(ACTIVE)
  createdAt                  DateTime                 @default(now())
  updatedAt                  DateTime                 @updatedAt
  emailVerified              DateTime?
  accounts                   Account[]
  sessions                   Session[]
  auditLogs                  AuditLog[]               @relation("AuditLogs")
  cashCollections            CashCollection[]         @relation("CashCollector")
  clientsAssigned            Client[]                 @relation("AsesorClients")
  clientProfile              Client?                  @relation("UserClient")
  creditApplicationsCreated  CreditApplication[]      @relation("CreatedByAsesor")
  creditApplicationsReviewed CreditApplication[]      @relation("ReviewedByAdmin")
  files                      FileUpload[]             @relation("UserFiles")
  verifiedFiles              FileUpload[]             @relation("VerifiedFiles")
  filesUploaded              File[]                   @relation("UserDualFiles")
  moduleChangeLogs           ModuleChangeLog[]        @relation("ModuleChangeLogs")
  rolePermissionUpdates      ModuleRolePermission[]   @relation("RolePermissionUpdates")
  notifications              Notification[]           @relation("UserNotifications")
  paymentsProcessed          Payment[]                @relation("ProcessedBy")
  moduleUpdates              PWAModule[]              @relation("ModuleUpdates")
  generatedReports           ReportGeneration[]       @relation("GeneratedReports")
  configUpdates              SystemConfig[]           @relation("ConfigUpdates")
  collectionVisits           CollectionVisit[]        @relation("AdvisorVisits")
  assignedConversations      Conversation[]           @relation("AssignedConversations")
  sentMessages               ConversationMessage[]    @relation("SentMessages")
  createdReportTemplates     ReportTemplate[]         @relation("CreatedReportTemplates")
  customReports              CustomReportGeneration[] @relation("CustomReports")
  
  // Two-Factor Authentication
  twoFactorEnabled           Boolean?                 @default(false)
  twoFactorSecret            String?
  twoFactorBackupCodes       String?                  // JSON array of backup codes

  tenantId                   String?
  tenant                     Tenant?                  @relation(fields: [tenantId], references: [id])

  @@map("users")
}

model Client {
  id                           String              @id @default(cuid())
  userId                       String?             @unique
  firstName                    String
  lastName                     String
  email                        String?             @unique
  phone                        String
  dateOfBirth                  DateTime?
  address                      String?
  city                         String?
  state                        String?
  postalCode                   String?
  monthlyIncome                Decimal?            @db.Decimal(12, 2)
  employmentType               EmploymentType?
  employerName                 String?
  workAddress                  String?
  yearsEmployed                Int?
  creditScore                  Int?
  bankName                     String?
  accountNumber                String?
  status                       ClientStatus        @default(ACTIVE)
  asesorId                     String?
  createdAt                    DateTime            @default(now())
  updatedAt                    DateTime            @updatedAt
  migratedFrom                 String?
  migrationDate                DateTime?
  initialBalance               Decimal?            @db.Decimal(12, 2)
  lastPaymentDate              DateTime?
  notes                        String?
  whatsappNotificationsEnabled Boolean             @default(true)
  whatsappPaymentReceived      Boolean             @default(true)
  whatsappPaymentReminder      Boolean             @default(true)
  whatsappLoanUpdates          Boolean             @default(true)
  whatsappMarketingMessages    Boolean             @default(false)
  profileImage                 String?
  asesor                       User?               @relation("AsesorClients", fields: [asesorId], references: [id])
  user                         User?               @relation("UserClient", fields: [userId], references: [id])
  creditApplications           CreditApplication[]
  creditScores                 CreditScore[]       @relation("ClientScoring")
  files                        FileUpload[]        @relation("ClientFiles")
  dualFiles                    File[]              @relation("ClientDualFiles")
  loans                        Loan[]
  personalReferences           PersonalReference[] @relation("ClientReferences")
  guarantor                    Guarantor?          @relation("ClientGuarantor")
  collaterals                  Collateral[]        @relation("ClientCollateral")
  whatsappMessages             WhatsAppMessage[]   @relation("ClientMessages")
  collectionVisits             CollectionVisit[]   @relation("ClientVisits")
  conversations                Conversation[]      @relation("ClientConversations")

  tenantId                     String?
  tenant                       Tenant?             @relation(fields: [tenantId], references: [id])

  @@map("clients")
}

model CollectionVisit {
  id          String    @id @default(cuid())
  clientId    String
  advisorId   String
  visitDate   DateTime  @default(now())
  latitude    Float?
  longitude   Float?
  address     String? // Dirección aproximada o detectada
  notes       String?
  outcome     String? // Resultado: Promesa de pago, No encontrado, Pagó, etc.
  promiseDate DateTime? // Si hubo promesa de pago
  photoUrl    String? // Evidencia de visita
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  client  Client @relation("ClientVisits", fields: [clientId], references: [id], onDelete: Cascade)
  advisor User   @relation("AdvisorVisits", fields: [advisorId], references: [id])

  @@index([clientId])
  @@index([advisorId])
  @@map("collection_visits")
}

model PersonalReference {
  id                     String                 @id @default(cuid())
  clientId               String
  fullName               String
  relationship           RelationshipType
  relationshipOther      String?
  phone                  String
  address                String?
  notificationPreference NotificationPreference @default(WHATSAPP)
  isActive               Boolean                @default(true)
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  client                 Client                 @relation("ClientReferences", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("personal_references")
}

model Guarantor {
  id           String           @id @default(cuid())
  clientId     String           @unique
  fullName     String
  address      String
  phone        String
  relationship RelationshipType
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  client       Client           @relation("ClientGuarantor", fields: [clientId], references: [id], onDelete: Cascade)

  @@map("guarantors")
}

model Collateral {
  id          String   @id @default(cuid())
  clientId    String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  client      Client   @relation("ClientCollateral", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("collaterals")
}

model CreditApplication {
  id              String            @id @default(cuid())
  clientId        String
  asesorId        String
  loanType        LoanType
  requestedAmount Decimal           @db.Decimal(12, 2)
  requestedTerm   Int
  purpose         String
  status          ApplicationStatus @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  reviewComments  String?
  approvedAmount  Decimal?          @db.Decimal(12, 2)
  approvedTerm    Int?
  interestRate    Decimal?          @db.Decimal(5, 4)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       User              @relation("CreatedByAsesor", fields: [asesorId], references: [id])
  client          Client            @relation(fields: [clientId], references: [id])
  reviewedByUser  User?             @relation("ReviewedByAdmin", fields: [reviewedBy], references: [id])
  creditScores    CreditScore[]     @relation("ApplicationScoring")
  loan            Loan?

  @@map("credit_applications")
}

model Loan {
  id                   String                 @id @default(cuid())
  clientId             String
  creditApplicationId  String?                @unique
  loanNumber           String                 @unique
  loanType             LoanType
  loanCalculationType  LoanCalculationType    @default(INTERES)
  principalAmount      Decimal                @db.Decimal(12, 2)
  interestRate         Decimal                @db.Decimal(5, 4)
  weeklyInterestAmount Decimal?               @db.Decimal(12, 2) // Para INTERES_SEMANAL
  termMonths           Int
  paymentFrequency     PaymentFrequency       @default(MENSUAL)
  monthlyPayment       Decimal                @db.Decimal(12, 2)
  initialPayment       Decimal?               @db.Decimal(12, 2)
  totalAmount          Decimal                @db.Decimal(12, 2)
  balanceRemaining     Decimal                @db.Decimal(12, 2)
  status               LoanStatus             @default(ACTIVE)
  startDate            DateTime
  endDate              DateTime
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  amortizationSchedule AmortizationSchedule[]
  creditScores         CreditScore[]          @relation("LoanScoring")
  files                FileUpload[]           @relation("LoanFiles")
  client               Client                 @relation(fields: [clientId], references: [id])
  creditApplication    CreditApplication?     @relation(fields: [creditApplicationId], references: [id])
  payments             Payment[]

  @@map("loans")
}

model WeeklyInterestRate {
  id                   String   @id @default(cuid())
  minAmount            Decimal  @db.Decimal(12, 2) // Monto mínimo
  maxAmount            Decimal  @db.Decimal(12, 2) // Monto máximo
  weeklyInterestRate   Decimal  @db.Decimal(5, 2) // Porcentaje de interés semanal
  weeklyInterestAmount Decimal  @db.Decimal(12, 2) // Monto de interés semanal en pesos
  isActive             Boolean  @default(true) // Para habilitar/deshabilitar
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("weekly_interest_rates")
}

model AmortizationSchedule {
  id               String   @id @default(cuid())
  loanId           String
  paymentNumber    Int
  paymentDate      DateTime
  principalPayment Decimal  @db.Decimal(12, 2)
  interestPayment  Decimal  @db.Decimal(12, 2)
  totalPayment     Decimal  @db.Decimal(12, 2)
  remainingBalance Decimal  @db.Decimal(12, 2)
  isPaid           Boolean  @default(false)
  loan             Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  payment          Payment?

  @@unique([loanId, paymentNumber])
  @@map("amortization_schedule")
}

model Payment {
  id                     String                @id @default(cuid())
  loanId                 String
  amortizationScheduleId String?               @unique
  amount                 Decimal               @db.Decimal(12, 2)
  paymentDate            DateTime
  paymentMethod          PaymentMethod
  status                 PaymentStatus         @default(COMPLETED)
  reference              String?
  notes                  String?
  processedBy            String?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  cashCollection         CashCollection?       @relation("CashCollections")
  transactions           PaymentTransaction[]  @relation("PaymentTransactions")
  amortizationSchedule   AmortizationSchedule? @relation(fields: [amortizationScheduleId], references: [id])
  loan                   Loan                  @relation(fields: [loanId], references: [id])
  processedByUser        User?                 @relation("ProcessedBy", fields: [processedBy], references: [id])

  @@map("payments")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  userEmail  String?
  action     String
  resource   String?
  resourceId String?
  details    String?
  ipAddress  String?
  userAgent  String?
  metadata   String?
  timestamp  DateTime @default(now())
  user       User?    @relation("AuditLogs", fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@map("audit_logs")
}

model CreditScore {
  id              String                @id @default(cuid())
  loanId          String?
  clientId        String?
  applicationId   String?
  score           Int
  risk            RiskLevel
  recommendation  ScoringRecommendation
  maxAmount       Decimal?              @db.Decimal(12, 2)
  recommendedRate Decimal?              @db.Decimal(5, 4)
  factors         String
  calculatedAt    DateTime              @default(now())
  validUntil      DateTime?
  createdAt       DateTime              @default(now())
  application     CreditApplication?    @relation("ApplicationScoring", fields: [applicationId], references: [id])
  client          Client?               @relation("ClientScoring", fields: [clientId], references: [id])
  loan            Loan?                 @relation("LoanScoring", fields: [loanId], references: [id])

  @@map("credit_scores")
}

model Notification {
  id           String              @id @default(cuid())
  userId       String
  type         NotificationType
  channel      NotificationChannel
  status       NotificationStatus  @default(PENDING)
  title        String
  message      String
  data         String?
  scheduledFor DateTime?
  sentAt       DateTime?
  readAt       DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([scheduledFor])
  @@map("notifications")
}

model FileUpload {
  id               String       @id @default(cuid())
  userId           String
  clientId         String?
  loanId           String?
  filename         String
  originalName     String
  mimeType         String
  size             Int
  category         FileCategory
  status           FileStatus   @default(UPLOADED)
  cloudStoragePath String
  description      String?
  uploadedAt       DateTime     @default(now())
  verifiedAt       DateTime?
  verifiedBy       String?
  expiresAt        DateTime?
  client           Client?      @relation("ClientFiles", fields: [clientId], references: [id])
  loan             Loan?        @relation("LoanFiles", fields: [loanId], references: [id])
  user             User         @relation("UserFiles", fields: [userId], references: [id], onDelete: Cascade)
  verifierUser     User?        @relation("VerifiedFiles", fields: [verifiedBy], references: [id])

  @@index([userId])
  @@index([clientId])
  @@index([loanId])
  @@map("file_uploads")
}

model PaymentTransaction {
  id                    String                   @id @default(cuid())
  paymentId             String
  provider              PaymentProviderType
  providerTransactionId String?
  amount                Decimal                  @db.Decimal(12, 2)
  currency              String                   @default("MXN")
  status                PaymentTransactionStatus @default(PENDING)
  providerResponse      String?
  errorMessage          String?
  processedAt           DateTime?
  webhookData           String?
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  payment               Payment                  @relation("PaymentTransactions", fields: [paymentId], references: [id], onDelete: Cascade)

  @@unique([provider, providerTransactionId])
  @@index([status])
  @@map("payment_transactions")
}

model CashCollection {
  id                String   @id @default(cuid())
  paymentId         String   @unique
  collectorId       String
  collectionMethod  String
  collectorLocation String
  photoEvidence     String?
  deviceInfo        String?
  collectionNotes   String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  collector         User     @relation("CashCollector", fields: [collectorId], references: [id])
  payment           Payment  @relation("CashCollections", fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([collectorId])
  @@index([collectionMethod])
  @@map("cash_collections")
}

model SystemConfig {
  id            String   @id @default(cuid())
  key           String
  value         String
  description   String?
  category      String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  updatedBy     String?
  updatedByUser User?    @relation("ConfigUpdates", fields: [updatedBy], references: [id])
  
  tenantId      String?
  tenant        Tenant?  @relation(fields: [tenantId], references: [id])

  @@unique([key, tenantId])
  @@index([category])
  @@index([key])
  @@map("system_config")
}

model ReportGeneration {
  id          String       @id @default(cuid())
  userId      String
  type        ReportType
  status      ReportStatus @default(PENDING)
  title       String
  description String?
  parameters  String?
  filePath    String?
  fileSize    Int?
  generatedAt DateTime?
  expiresAt   DateTime?
  createdAt   DateTime     @default(now())
  user        User         @relation("GeneratedReports", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("report_generations")
}

model WhatsAppMessage {
  id            String                @id @default(cuid())
  clientId      String
  phone         String
  messageType   WhatsAppMessageType
  status        WhatsAppMessageStatus @default(PENDING)
  message       String
  mediaUrl      String?
  scheduledFor  DateTime?
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  errorMessage  String?
  wahaMessageId String?
  wahaResponse  String?
  paymentId     String?
  loanId        String?
  metadata      String?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  client        Client                @relation("ClientMessages", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([status])
  @@index([scheduledFor])
  @@index([paymentId])
  @@map("whatsapp_messages")
}

model MessageTemplate {
  id          String              @id @default(cuid())
  name        String
  description String?
  category    MessageTemplateType
  channel     MessageChannel
  template    String
  variables   String?
  maxLength   Int?
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  tenantId    String?
  tenant      Tenant?             @relation(fields: [tenantId], references: [id])
  
  @@unique([name, tenantId])
  @@index([category])
  @@index([channel])
  @@map("message_templates")
}

model WahaConfig {
  id                      String   @id @default(cuid())
  sessionId               String   @default("default")
  apiKey                  String?
  baseUrl                 String
  webhookUrl              String?
  isActive                Boolean  @default(true)
  paymentReceivedTemplate String?
  paymentReminderTemplate String?
  loanApprovedTemplate    String?
  loanUpdateTemplate      String?
  marketingTemplate       String?
  n8nWebhookUrl           String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  tenantId                String?
  tenant                  Tenant?  @relation(fields: [tenantId], references: [id])

  @@unique([sessionId, tenantId])
  @@map("waha_config")
}

model File {
  id           String   @id @default(cuid())
  fileName     String
  originalName String
  filePath     String
  fileSize     Int
  mimeType     String
  category     String   @default("general")
  description  String?
  clientId     String?
  uploadedById String
  storageType  String   @default("local")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  client       Client?  @relation("ClientDualFiles", fields: [clientId], references: [id])
  uploadedBy   User     @relation("UserDualFiles", fields: [uploadedById], references: [id])

  @@index([clientId])
  @@index([uploadedById])
  @@index([category])
  @@index([createdAt])
  @@map("files")
}

model PWAModule {
  id               String                 @id @default(cuid())
  moduleKey        String                 @unique
  name             String
  description      String?
  category         ModuleCategory
  status           ModuleStatus           @default(ENABLED)
  isCore           Boolean                @default(false)
  requiredFor      String[]
  availableFor     String[]
  icon             String?
  route            String?
  sortOrder        Int                    @default(0)
  config           String?
  version          String                 @default("1.0.0")
  minSystemVersion String?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  updatedBy        String?
  rolePermissions  ModuleRolePermission[] @relation("ModulePermissions")
  updatedByUser    User?                  @relation("ModuleUpdates", fields: [updatedBy], references: [id])

  @@index([category])
  @@index([status])
  @@index([sortOrder])
  @@map("pwa_modules")
}

model ModuleRolePermission {
  id            String    @id @default(cuid())
  moduleId      String
  role          UserRole
  enabled       Boolean   @default(true)
  permissions   String?
  config        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  updatedBy     String?
  module        PWAModule @relation("ModulePermissions", fields: [moduleId], references: [id], onDelete: Cascade)
  updatedByUser User?     @relation("RolePermissionUpdates", fields: [updatedBy], references: [id])

  @@unique([moduleId, role])
  @@index([role])
  @@map("module_role_permissions")
}

model ModuleChangeLog {
  id        String    @id @default(cuid())
  moduleId  String
  action    String
  role      UserRole?
  oldValue  String?
  newValue  String?
  reason    String?
  userId    String
  createdAt DateTime  @default(now())
  user      User      @relation("ModuleChangeLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([action])
  @@index([createdAt])
  @@map("module_change_logs")
}

enum UserRole {
  ADMIN
  ASESOR
  CLIENTE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  BLACKLISTED
}

enum EmploymentType {
  EMPLOYED
  SELF_EMPLOYED
  UNEMPLOYED
  RETIRED
  STUDENT
}

enum RelationshipType {
  FAMILY
  FRIEND
  COWORKER
  NEIGHBOR
  OTHER
}

enum NotificationPreference {
  SMS
  WHATSAPP
  BOTH
  NONE
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  CANCELLED
}

enum LoanType {
  PERSONAL
  BUSINESS
  MORTGAGE
  AUTO
  EDUCATION
}

enum LoanStatus {
  ACTIVE
  PAID_OFF
  DEFAULTED
  CANCELLED
}

enum PaymentFrequency {
  SEMANAL
  CATORCENAL
  QUINCENAL
  MENSUAL
}

enum LoanCalculationType {
  INTERES // Sistema de interés tradicional
  TARIFA_FIJA // Sistema de tarifa fija por monto
  INTERES_SEMANAL // Sistema de interés semanal sobre capital
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHECK
  DEBIT_CARD
  CREDIT_CARD
  ONLINE
  MIGRATION
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum ScoringRecommendation {
  APPROVE
  REVIEW
  REJECT
}

enum NotificationType {
  PAYMENT_DUE
  PAYMENT_OVERDUE
  LOAN_APPROVED
  LOAN_REJECTED
  SYSTEM_ALERT
  MARKETING
  REMINDER
}

enum NotificationStatus {
  PENDING
  SENT
  READ
  FAILED
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

enum FileCategory {
  IDENTITY_DOCUMENT
  INCOME_PROOF
  BANK_STATEMENT
  CONTRACT
  SIGNATURE
  PHOTO
  OTHER
}

enum FileStatus {
  UPLOADED
  VERIFIED
  REJECTED
  EXPIRED
}

enum PaymentProviderType {
  OPENPAY
  STRIPE
  PAYPAL
  BANK_TRANSFER
  MANUAL
}

enum PaymentTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum ReportType {
  LOAN_PORTFOLIO
  PAYMENT_ANALYSIS
  CLIENT_DEMOGRAPHICS
  FINANCIAL_SUMMARY
  RISK_ASSESSMENT
  AUDIT_TRAIL
  CUSTOM
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

enum WhatsAppMessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum WhatsAppMessageType {
  PAYMENT_RECEIVED
  PAYMENT_REMINDER
  LOAN_APPROVED
  LOAN_UPDATE
  MARKETING
  CUSTOM
}

enum ModuleCategory {
  DASHBOARD
  LOANS
  PAYMENTS
  CLIENTS
  REPORTS
  NOTIFICATIONS
  INTEGRATIONS
  TOOLS
  ANALYTICS
}

enum ModuleStatus {
  ENABLED
  DISABLED
  BETA
  MAINTENANCE
}

enum MessageTemplateType {
  ACCOUNT_CREATED
  PAYMENT_RECEIVED
  PAYMENT_REMINDER
  PAYMENT_OVERDUE
  LOAN_APPROVED
  LOAN_DISBURSED
  LOAN_REJECTED
  LOAN_UPDATE
  CREDIT_APPLICATION_RECEIVED
  CREDIT_APPLICATION_APPROVED
  CREDIT_APPLICATION_REJECTED
  WELCOME
  MARKETING
  CUSTOM
}

enum MessageChannel {
  SMS
  WHATSAPP
  CHATWOOT
  EMAIL
  PUSH
}

// ============================================
// MODELOS NUEVOS - FEBRERO 2026
// ============================================

// 1. ENTRENAMIENTO CONTINUO DEL MODELO IA
model MLTrainingData {
  id              String    @id @default(cuid())
  loanId          String
  clientId        String
  predictionScore Int // Score predicho
  actualOutcome   Boolean // Resultado real (true = pagó bien, false = incumplió)
  predictionDate  DateTime
  outcomeDate     DateTime?
  features        String // JSON con features usados en la predicción
  createdAt       DateTime  @default(now())

  @@index([loanId])
  @@index([clientId])
  @@index([predictionDate])
  @@map("ml_training_data")
}

model MLModel {
  id            String    @id @default(cuid())
  version       String    @unique // v1.0.0, v1.1.0, etc.
  weights       String // JSON con pesos del modelo
  metrics       String // JSON con métricas (accuracy, precision, recall, etc.)
  trainingSize  Int // Cantidad de registros usados para entrenar
  isActive      Boolean   @default(false)
  trainedAt     DateTime
  activatedAt   DateTime?
  deactivatedAt DateTime?
  notes         String?
  createdBy     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([isActive])
  @@index([trainedAt])
  @@map("ml_models")
}

// 2. WHATSAPP BIDIRECCIONAL Y CONVERSACIONES
model Conversation {
  id            String             @id @default(cuid())
  clientId      String
  phone         String
  status        ConversationStatus @default(ACTIVE)
  lastMessageAt DateTime           @default(now())
  assignedToId  String? // Asesor asignado
  notes         String?
  metadata      String? // JSON con metadata adicional
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  client     Client                @relation("ClientConversations", fields: [clientId], references: [id], onDelete: Cascade)
  assignedTo User?                 @relation("AssignedConversations", fields: [assignedToId], references: [id])
  messages   ConversationMessage[]

  @@index([clientId])
  @@index([status])
  @@index([assignedToId])
  @@map("conversations")
}

model ConversationMessage {
  id             String                  @id @default(cuid())
  conversationId String
  direction      MessageDirection // INBOUND / OUTBOUND
  content        String
  messageType    ConversationMessageType @default(TEXT)
  mediaUrl       String?
  wahaMessageId  String?
  status         MessageStatus           @default(SENT)
  sentBy         String? // User ID si es outbound
  readAt         DateTime?
  deliveredAt    DateTime?
  metadata       String? // JSON
  createdAt      DateTime                @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User?        @relation("SentMessages", fields: [sentBy], references: [id])

  @@index([conversationId])
  @@index([direction])
  @@index([createdAt])
  @@map("conversation_messages")
}

model ChatbotRule {
  id           String       @id @default(cuid())
  trigger      String // Palabra clave o regex
  triggerType  TriggerType  @default(KEYWORD)
  response     String // Respuesta automática
  responseType ResponseType @default(TEXT)
  priority     Int          @default(0)
  isActive     Boolean      @default(true)
  conditions   String? // JSON con condiciones adicionales
  actions      String? // JSON con acciones a ejecutar
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([isActive])
  @@index([priority])
  @@map("chatbot_rules")
}

// 3. GENERACIÓN DE REPORTES PERSONALIZADOS
model ReportTemplate {
  id           String   @id @default(cuid())
  name         String
  description  String?
  category     String   @default("custom")
  config       String // JSON con configuración del reporte (queries, filtros, etc.)
  layoutConfig String? // JSON con layout drag-and-drop
  pdfTemplate  String? // Path al template PDF o HTML
  isPublic     Boolean  @default(false)
  createdBy    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  creator     User                     @relation("CreatedReportTemplates", fields: [createdBy], references: [id])
  schedules   ReportSchedule[]
  generations CustomReportGeneration[]

  tenantId    String?
  tenant      Tenant?                  @relation(fields: [tenantId], references: [id])

  @@unique([name, tenantId])
  @@index([category])
  @@index([isPublic])
  @@map("report_templates")
}

model ReportSchedule {
  id         String            @id @default(cuid())
  templateId String
  frequency  ScheduleFrequency
  dayOfWeek  Int? // 0-6 para WEEKLY
  dayOfMonth Int? // 1-31 para MONTHLY
  time       String // HH:MM formato
  recipients String // JSON array de emails
  isActive   Boolean           @default(true)
  lastRunAt  DateTime?
  nextRunAt  DateTime
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  template ReportTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([nextRunAt])
  @@map("report_schedules")
}

model CustomReportGeneration {
  id           String       @id @default(cuid())
  templateId   String
  userId       String
  status       ReportStatus @default(PENDING)
  parameters   String? // JSON con parámetros de generación
  filePath     String?
  fileSize     Int?
  generatedAt  DateTime?
  expiresAt    DateTime?
  errorMessage String?
  createdAt    DateTime     @default(now())

  template ReportTemplate @relation(fields: [templateId], references: [id])
  user     User           @relation("CustomReports", fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("custom_report_generations")
}

// ============================================
// NUEVOS ENUMS
// ============================================

enum ConversationStatus {
  ACTIVE
  RESOLVED
  ARCHIVED
  SPAM
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum ConversationMessageType {
  TEXT
  IMAGE
  DOCUMENT
  AUDIO
  VIDEO
  LOCATION
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum TriggerType {
  KEYWORD
  REGEX
  INTENT
}

enum ResponseType {
  TEXT
  TEMPLATE
  ACTION
}

enum ScheduleFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}
