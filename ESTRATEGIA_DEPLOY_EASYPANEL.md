
# üöÄ Estrategia Completa de Deploy en EasyPanel

**Proyecto:** EscalaFin MVP  
**Plataforma:** EasyPanel (Docker)  
**Fecha:** 16 de octubre de 2025  
**Versi√≥n:** 1.0

---

## üìã Tabla de Contenidos

1. [Pre-Deployment Checklist](#pre-deployment-checklist)
2. [Archivos Cr√≠ticos Requeridos](#archivos-cr√≠ticos-requeridos)
3. [Verificaci√≥n de Dependencias](#verificaci√≥n-de-dependencias)
4. [Estrategia de Errores Comunes](#estrategia-de-errores-comunes)
5. [Variables de Entorno Requeridas](#variables-de-entorno-requeridas)
6. [Plan de Rollback](#plan-de-rollback)
7. [Monitoreo Post-Deploy](#monitoreo-post-deploy)
8. [Scripts Automatizados](#scripts-automatizados)

---

## üéØ Pre-Deployment Checklist

### ‚úÖ Fase 1: Verificaci√≥n Local

```bash
# Ejecutar este script antes de hacer deploy
cd /home/ubuntu/escalafin_mvp
./scripts/pre-deploy-check.sh
```

#### Checklist Manual:

- [ ] **Dockerfile existe y es v√°lido**
  - Ruta: `/home/ubuntu/escalafin_mvp/Dockerfile`
  - Versi√≥n actual: v16.0
  - Verifica: `cat Dockerfile | head -20`

- [ ] **package.json y package-lock.json existen**
  - Ruta: `/home/ubuntu/escalafin_mvp/app/package.json`
  - Ruta: `/home/ubuntu/escalafin_mvp/app/package-lock.json`
  - lockfileVersion: 3

- [ ] **Prisma schema est√° completo**
  - Ruta: `/home/ubuntu/escalafin_mvp/app/prisma/schema.prisma`
  - Verifica modelos: User, Client, Loan, etc.

- [ ] **Scripts de inicio existen**
  - `start.sh` - Script de inicializaci√≥n
  - `healthcheck.sh` - Script de health check
  - Ambos deben tener permisos de ejecuci√≥n (chmod +x)

- [ ] **next.config.js configurado correctamente**
  - output: 'standalone' debe estar configurado
  - Verifica: `grep -A5 "output:" app/next.config.js`

- [ ] **Git est√° actualizado**
  - Sin cambios sin commitear
  - Branch: main
  - √öltimo commit pusheado

---

## üìÅ Archivos Cr√≠ticos Requeridos

### 1. **Dockerfile** (OBLIGATORIO)
```
/home/ubuntu/escalafin_mvp/Dockerfile
```
**Prop√≥sito:** Define c√≥mo construir la imagen Docker  
**Versi√≥n actual:** v16.0  
**Cr√≠tico:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

**Verificaci√≥n:**
```bash
test -f /home/ubuntu/escalafin_mvp/Dockerfile && echo "‚úÖ OK" || echo "‚ùå FALTA"
```

---

### 2. **.dockerignore** (RECOMENDADO)
```
/home/ubuntu/escalafin_mvp/.dockerignore
```
**Prop√≥sito:** Excluir archivos innecesarios del build  
**Cr√≠tico:** ‚≠ê‚≠ê‚≠ê‚≠ê

**Contenido recomendado:**
```
node_modules
.git
.env*
!.env.example
*.log
.next
dist
coverage
.vscode
.idea
*.md
!README.md
docs
test-scripts
testing-documentation
instances
escalafin-*.tar.gz
*.bundle
*_BACKUP_*
*_temp
```

---

### 3. **package.json** (OBLIGATORIO)
```
/home/ubuntu/escalafin_mvp/app/package.json
```
**Prop√≥sito:** Define dependencias y scripts  
**Cr√≠tico:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

**Scripts requeridos:**
```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  }
}
```

---

### 4. **package-lock.json** (OBLIGATORIO)
```
/home/ubuntu/escalafin_mvp/app/package-lock.json
```
**Prop√≥sito:** Lockfile de dependencias (lockfileVersion 3)  
**Cr√≠tico:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

---

### 5. **next.config.js** (OBLIGATORIO)
```
/home/ubuntu/escalafin_mvp/app/next.config.js
```
**Prop√≥sito:** Configuraci√≥n de Next.js  
**Cr√≠tico:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

**Configuraci√≥n requerida:**
```javascript
module.exports = {
  output: 'standalone',  // ‚ö†Ô∏è CR√çTICO para Docker
  // ... otras configuraciones
}
```

---

### 6. **prisma/schema.prisma** (OBLIGATORIO)
```
/home/ubuntu/escalafin_mvp/app/prisma/schema.prisma
```
**Prop√≥sito:** Schema de base de datos  
**Cr√≠tico:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

---

### 7. **start.sh** (RECOMENDADO)
```
/home/ubuntu/escalafin_mvp/start.sh
```
**Prop√≥sito:** Script de inicializaci√≥n con health checks  
**Cr√≠tico:** ‚≠ê‚≠ê‚≠ê‚≠ê

**Debe ser ejecutable:**
```bash
chmod +x /home/ubuntu/escalafin_mvp/start.sh
```

---

### 8. **healthcheck.sh** (RECOMENDADO)
```
/home/ubuntu/escalafin_mvp/healthcheck.sh
```
**Prop√≥sito:** Verificar salud del container  
**Cr√≠tico:** ‚≠ê‚≠ê‚≠ê

---

### 9. **.env.example** (RECOMENDADO)
```
/home/ubuntu/escalafin_mvp/.env.example
```
**Prop√≥sito:** Template de variables de entorno  
**Cr√≠tico:** ‚≠ê‚≠ê‚≠ê

---

## üîç Verificaci√≥n de Dependencias

### Script de Verificaci√≥n Autom√°tica

```bash
#!/bin/bash
# Verificar todas las dependencias cr√≠ticas

echo "üîç Verificando dependencias..."

# 1. Node.js y npm
node --version || echo "‚ùå Node.js no encontrado"
npm --version || echo "‚ùå npm no encontrado"

# 2. Archivos cr√≠ticos
FILES=(
  "Dockerfile"
  "app/package.json"
  "app/package-lock.json"
  "app/next.config.js"
  "app/prisma/schema.prisma"
  "start.sh"
  "healthcheck.sh"
)

for file in "${FILES[@]}"; do
  if [ -f "$file" ]; then
    echo "‚úÖ $file"
  else
    echo "‚ùå $file FALTA"
  fi
done

# 3. Verificar package.json scripts
if grep -q '"build"' app/package.json; then
  echo "‚úÖ Script 'build' encontrado"
else
  echo "‚ùå Script 'build' NO encontrado"
fi

# 4. Verificar output standalone en next.config.js
if grep -q "output.*standalone" app/next.config.js; then
  echo "‚úÖ output: 'standalone' configurado"
else
  echo "‚ö†Ô∏è  output: 'standalone' NO configurado"
fi

# 5. Verificar lockfileVersion
LOCKFILE_VERSION=$(grep -o '"lockfileVersion": [0-9]*' app/package-lock.json | grep -o '[0-9]*')
echo "‚ÑπÔ∏è  lockfileVersion: $LOCKFILE_VERSION"
```

---

## üö® Estrategia de Errores Comunes

### Error 1: "npm ci: lockfileVersion not supported"

**S√≠ntoma:**
```
npm error The npm ci command can only install with an existing package-lock.json
```

**Causa:**
- lockfileVersion incompatible con la versi√≥n de npm

**Soluci√≥n:**
```bash
# El Dockerfile v16.0 ya resuelve esto usando npm install
# Si persiste, verifica que est√©s usando la versi√≥n correcta del Dockerfile

# Verificar versi√≥n del Dockerfile
head -5 /home/ubuntu/escalafin_mvp/Dockerfile | grep "Versi√≥n:"
# Debe mostrar: Versi√≥n: 16.0 o superior
```

**Prevenci√≥n:**
- ‚úÖ Usa Dockerfile v16.0 o superior
- ‚úÖ No uses npm ci directamente, usa npm install

---

### Error 2: "Cannot find module 'next/server'"

**S√≠ntoma:**
```
Error: Cannot find module 'next/server'
```

**Causa:**
- Dependencias no instaladas correctamente
- node_modules corrupto

**Soluci√≥n:**
```bash
cd /home/ubuntu/escalafin_mvp/app
rm -rf node_modules package-lock.json
npm install
```

**Prevenci√≥n:**
- ‚úÖ Aseg√∫rate de que node_modules est√© en .dockerignore
- ‚úÖ Deja que Docker instale las dependencias desde cero

---

### Error 3: "Prisma Client not generated"

**S√≠ntoma:**
```
Error: @prisma/client did not initialize yet
```

**Causa:**
- Prisma generate no se ejecut√≥ durante el build

**Soluci√≥n:**
```bash
# Verifica que el Dockerfile incluya:
RUN npx prisma generate
```

**Prevenci√≥n:**
- ‚úÖ El Dockerfile v16.0 ya incluye prisma generate
- ‚úÖ Verifica en los logs del build que se ejecute

---

### Error 4: "standalone build not found"

**S√≠ntoma:**
```
Error: Cannot find standalone build
```

**Causa:**
- `output: 'standalone'` no configurado en next.config.js

**Soluci√≥n:**
```bash
# Editar app/next.config.js y agregar:
module.exports = {
  output: 'standalone',
  // ... resto de la configuraci√≥n
}
```

**Prevenci√≥n:**
- ‚úÖ Verifica next.config.js antes de cada deploy
- ‚úÖ Usa el script de verificaci√≥n pre-deploy

---

### Error 5: "Database connection failed"

**S√≠ntoma:**
```
Error: Can't reach database server
```

**Causa:**
- DATABASE_URL incorrecto o no configurado
- Base de datos no accesible desde el container

**Soluci√≥n:**
```bash
# 1. Verifica DATABASE_URL en EasyPanel
# 2. Aseg√∫rate de que la base de datos est√© corriendo
# 3. Verifica que el host sea accesible desde el container

# Para EasyPanel, usa el host interno si la DB est√° en EasyPanel:
postgresql://user:pass@postgres:5432/dbname

# Si la DB est√° externa, usa la IP/host externo:
postgresql://user:pass@external-db.com:5432/dbname
```

**Prevenci√≥n:**
- ‚úÖ Prueba la conexi√≥n a la DB antes del deploy
- ‚úÖ Usa nombres de host internos si la DB est√° en EasyPanel

---

### Error 6: "AWS credentials not found"

**S√≠ntoma:**
```
Error: Missing credentials in config
```

**Causa:**
- Variables de entorno de AWS no configuradas

**Soluci√≥n:**
```bash
# Configurar en EasyPanel:
AWS_ACCESS_KEY_ID=tu_access_key
AWS_SECRET_ACCESS_KEY=tu_secret_key
AWS_REGION=us-east-1
AWS_BUCKET_NAME=tu_bucket
AWS_FOLDER_PREFIX=escalafin/
```

**Prevenci√≥n:**
- ‚úÖ Usa .env.example como referencia
- ‚úÖ Verifica que todas las variables est√©n en EasyPanel

---

### Error 7: "NEXTAUTH_SECRET not set"

**S√≠ntoma:**
```
Error: Please provide NEXTAUTH_SECRET
```

**Causa:**
- NEXTAUTH_SECRET no configurado

**Soluci√≥n:**
```bash
# Generar un secret aleatorio:
openssl rand -base64 32

# O usar Node.js:
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"

# Configurar en EasyPanel:
NEXTAUTH_SECRET=tu_secret_generado
```

**Prevenci√≥n:**
- ‚úÖ Genera secrets √∫nicos para cada ambiente
- ‚úÖ NUNCA reutilices secrets entre dev y production

---

### Error 8: "Port already in use"

**S√≠ntoma:**
```
Error: Port 3000 is already in use
```

**Causa:**
- Puerto configurado incorrectamente en EasyPanel

**Soluci√≥n:**
```bash
# En EasyPanel:
# 1. Ve a Settings > Ports
# 2. Configura el puerto del container: 3000
# 3. Configura el puerto p√∫blico: 80 o 443
```

**Prevenci√≥n:**
- ‚úÖ Usa siempre el puerto 3000 dentro del container
- ‚úÖ Deja que EasyPanel maneje el mapeo de puertos

---

## üîê Variables de Entorno Requeridas

### Variables OBLIGATORIAS

```bash
# Base de Datos (CR√çTICO ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê)
DATABASE_URL=postgresql://user:password@host:5432/dbname

# NextAuth (CR√çTICO ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê)
NEXTAUTH_URL=https://tu-dominio.com
NEXTAUTH_SECRET=tu_secret_super_seguro_aqui

# Node Environment (CR√çTICO ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê)
NODE_ENV=production
```

### Variables RECOMENDADAS

```bash
# AWS S3 (para file uploads)
AWS_ACCESS_KEY_ID=tu_access_key
AWS_SECRET_ACCESS_KEY=tu_secret_key
AWS_REGION=us-east-1
AWS_BUCKET_NAME=tu_bucket_name
AWS_FOLDER_PREFIX=escalafin/

# Openpay (para pagos)
OPENPAY_MERCHANT_ID=tu_merchant_id
OPENPAY_PRIVATE_KEY=tu_private_key
OPENPAY_PUBLIC_KEY=tu_public_key
OPENPAY_API_ENDPOINT=https://api.openpay.mx/v1
OPENPAY_IS_PRODUCTION=true

# Evolution API (para WhatsApp)
EVOLUTION_API_URL=https://tu-evolution-api.com
EVOLUTION_API_KEY=tu_api_key
EVOLUTION_INSTANCE_NAME=tu_instancia

# Configuraci√≥n Adicional
NEXT_PUBLIC_APP_URL=https://tu-dominio.com
SKIP_ENV_VALIDATION=false
```

### C√≥mo Configurar en EasyPanel

1. **Navega a tu aplicaci√≥n en EasyPanel**
2. **Ve a Settings > Environment**
3. **Agrega cada variable una por una**
4. **Guarda y reinicia la aplicaci√≥n**

---

## üîÑ Plan de Rollback

### Estrategia de Rollback en 3 Niveles

#### Nivel 1: Rollback R√°pido (< 5 minutos)

**Cu√°ndo usar:** El deploy fall√≥ pero la versi√≥n anterior est√° disponible

```bash
# En EasyPanel:
# 1. Ve a Deployments
# 2. Encuentra el √∫ltimo deployment exitoso
# 3. Click en "Redeploy"
# 4. Espera a que termine
```

#### Nivel 2: Rollback por Git (< 15 minutos)

**Cu√°ndo usar:** Necesitas revertir cambios en el c√≥digo

```bash
# 1. Identifica el commit anterior estable
git log --oneline -10

# 2. Revierte al commit estable
git revert <commit-hash>

# O resetea (si no has pusheado):
git reset --hard <commit-hash>

# 3. Push
git push origin main

# 4. Redeploy en EasyPanel
```

#### Nivel 3: Rollback Completo (< 30 minutos)

**Cu√°ndo usar:** Todo fall√≥ y necesitas restaurar desde backup

```bash
# 1. Restaurar c√≥digo desde backup
cp -r /home/ubuntu/escalafin_mvp_BACKUP_* /home/ubuntu/escalafin_mvp

# 2. Restaurar base de datos
# Ver script: restore-db.sh

# 3. Verificar y redeploy
cd /home/ubuntu/escalafin_mvp
./scripts/pre-deploy-check.sh
# Redeploy en EasyPanel
```

---

## üìä Monitoreo Post-Deploy

### Checklist de Verificaci√≥n Post-Deploy

**Inmediatamente despu√©s del deploy (0-5 minutos):**

- [ ] **Container est√° corriendo**
  - En EasyPanel: Status = Running (verde)
  
- [ ] **Logs no muestran errores cr√≠ticos**
  - En EasyPanel: Ve a Logs
  - Busca: "Server started", "Listening on port 3000"
  - No debe haber: "Error", "FATAL", "cannot connect"

- [ ] **Health check pasa**
  - En EasyPanel: Ve a Health Checks
  - Status debe ser: Healthy
  
- [ ] **URL responde**
  - Abre: https://tu-dominio.com
  - Debe cargar la p√°gina de login

**30 minutos despu√©s del deploy:**

- [ ] **Login funciona**
  - Prueba login con usuario de prueba
  
- [ ] **Database queries funcionan**
  - Verifica que el dashboard cargue datos
  
- [ ] **File uploads funcionan** (si aplica)
  - Sube un documento de prueba
  
- [ ] **Payments funcionan** (si aplica)
  - Crea una transacci√≥n de prueba

**24 horas despu√©s del deploy:**

- [ ] **No memory leaks**
  - En EasyPanel: Ve a Metrics
  - Memoria debe ser estable, no creciendo constantemente
  
- [ ] **No errores recurrentes en logs**
  - Revisa logs para patrones de error
  
- [ ] **Performance aceptable**
  - Tiempos de respuesta < 2 segundos

---

## üõ†Ô∏è Scripts Automatizados

### Script 1: Pre-Deploy Check

Ver: `/home/ubuntu/escalafin_mvp/scripts/pre-deploy-check.sh`

### Script 2: Post-Deploy Verification

Ver: `/home/ubuntu/escalafin_mvp/scripts/post-deploy-check.sh`

### Script 3: Emergency Rollback

Ver: `/home/ubuntu/escalafin_mvp/scripts/emergency-rollback.sh`

---

## üìû Soporte y Recursos

### Documentaci√≥n de Referencia

1. **MULTI_INSTANCE_GUIDE.md** - Gu√≠a de deployment multi-instancia
2. **COOLIFY_DEPLOYMENT_GUIDE.md** - Gu√≠a de Coolify (similar a EasyPanel)
3. **EASYPANEL_DOCKER_GUIDE.md** - Gu√≠a espec√≠fica de EasyPanel
4. **FIX_NPM_CI_LOCKFILEVERSION.md** - Fix del error npm ci

### Logs para Debugging

```bash
# En EasyPanel, accede a:
# 1. Logs en tiempo real
# 2. Logs hist√≥ricos (√∫ltimas 24 horas)
# 3. M√©tricas de performance

# Filtrar logs por nivel:
# - ERROR: Solo errores cr√≠ticos
# - WARN: Advertencias
# - INFO: Informaci√≥n general
```

### Comandos √ötiles de Debugging

```bash
# Ver estado del container
docker ps -a | grep escalafin

# Ver logs del container
docker logs <container-id> --tail 100

# Entrar al container
docker exec -it <container-id> sh

# Verificar variables de entorno
docker exec <container-id> env | grep -E "DATABASE|NEXTAUTH|AWS"

# Verificar conectividad a DB
docker exec <container-id> nc -zv postgres-host 5432
```

---

## ‚úÖ Checklist Final

### Antes de Hacer Deploy

- [ ] C√≥digo commiteado y pusheado a GitHub
- [ ] Dockerfile v16.0 o superior
- [ ] Todas las variables de entorno configuradas en EasyPanel
- [ ] Base de datos est√° accesible
- [ ] Backup reciente existe
- [ ] Pre-deploy check ejecutado sin errores

### Durante el Deploy

- [ ] Monitorear logs en tiempo real
- [ ] Verificar que cada stage del build completa
- [ ] No cerrar la ventana hasta que termine

### Despu√©s del Deploy

- [ ] Container en estado "Running"
- [ ] Health check pasa
- [ ] URL principal carga
- [ ] Login funciona
- [ ] Sin errores cr√≠ticos en logs

---

## üéØ Resumen Ejecutivo

### ‚ö° Deploy Exitoso en 10 Pasos

1. ‚úÖ Ejecutar `pre-deploy-check.sh`
2. ‚úÖ Verificar Dockerfile v16.0
3. ‚úÖ Commit y push a GitHub
4. ‚úÖ Configurar variables de entorno en EasyPanel
5. ‚úÖ Iniciar deploy desde EasyPanel
6. ‚úÖ Monitorear logs durante build
7. ‚úÖ Esperar a que container est√© "Running"
8. ‚úÖ Verificar health check
9. ‚úÖ Probar URL principal
10. ‚úÖ Ejecutar `post-deploy-check.sh`

### üö® En Caso de Error

1. üîç Revisar logs en EasyPanel
2. üìã Consultar "Estrategia de Errores Comunes" arriba
3. üîÑ Aplicar fix correspondiente
4. üîÑ Si no funciona, ejecutar rollback
5. üìû Documentar el error para futuras referencias

---

**√öltima actualizaci√≥n:** 16 de octubre de 2025  
**Versi√≥n:** 1.0  
**Mantenido por:** Equipo EscalaFin
